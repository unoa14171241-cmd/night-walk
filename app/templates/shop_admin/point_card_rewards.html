{% extends "base.html" %}

{% block title %}特典管理 - {{ shop.name }} - Night-Walk{% endblock %}

{% block content %}
<div class="shop-admin-layout">
 <div class="shop-admin-content">
 <div class="d-flex justify-between align-center mb-4">
 <h1 class="mb-0">特典管理</h1>
 <div class="d-flex gap-2 align-center">
 <a href="{{ url_for('shop_admin.point_card') }}" class="btn btn-outline-secondary btn-sm">
 スタンプカード管理へ戻る
 </a>
 <span class="text-muted">{{ shop.name }}</span>
 </div>
 </div>

 {% if pending_count > 0 %}
 <div class="alert alert-warning mb-4">
 <strong>{{ pending_count }}件</strong>の未使用特典があります。お客様が来店した際に「利用済み」ボタンを押してください。
 </div>
 {% endif %}

 <!-- フィルター -->
 <div class="card mb-4">
 <div class="d-flex gap-2">
 <a href="{{ url_for('shop_admin.point_card_rewards', status='pending') }}"
 class="btn {{ 'btn-primary' if status_filter == 'pending' else 'btn-outline-primary' }} btn-sm">
 未使用
 </a>
 <a href="{{ url_for('shop_admin.point_card_rewards', status='used') }}"
 class="btn {{ 'btn-primary' if status_filter == 'used' else 'btn-outline-primary' }} btn-sm">
 利用済み
 </a>
 <a href="{{ url_for('shop_admin.point_card_rewards', status='all') }}"
 class="btn {{ 'btn-primary' if status_filter == 'all' else 'btn-outline-primary' }} btn-sm">
 全て
 </a>
 </div>
 </div>

 <!-- 特典一覧 -->
 {% if rewards %}
 <div class="card">
 <div class="table-responsive">
 <table class="table">
 <thead>
 <tr>
 <th>お客様</th>
 <th>特典内容</th>
 <th>交換日</th>
 <th>有効期限</th>
 <th>ステータス</th>
 <th></th>
 </tr>
 </thead>
 <tbody>
 {% for reward in rewards %}
 <tr>
 <td>
 <strong>{{ reward.customer.nickname or '---' }}</strong>
 <br><small class="text-muted">{{ reward.customer.email }}</small>
 </td>
 <td>{{ reward.reward_description }}</td>
 <td>{{ reward.created_at.strftime('%Y/%m/%d %H:%M') if reward.created_at else '---' }}</td>
 <td>
 {% if reward.expires_at %}
 {{ reward.expires_at.strftime('%Y/%m/%d') }}
 {% if reward.is_valid %}
 <span class="badge badge-success" style="font-size: 0.7rem;">有効</span>
 {% else %}
 <span class="badge badge-secondary" style="font-size: 0.7rem;">期限切れ</span>
 {% endif %}
 {% else %}
 無期限
 {% endif %}
 </td>
 <td>
 {% if reward.status == 'pending' %}
 <span class="badge badge-warning">未使用</span>
 {% elif reward.status == 'used' %}
 <span class="badge badge-success">利用済み</span>
 {% elif reward.status == 'expired' %}
 <span class="badge badge-secondary">期限切れ</span>
 {% else %}
 <span class="badge badge-secondary">{{ reward.status }}</span>
 {% endif %}
 </td>
 <td>
 {% if reward.status == 'pending' and reward.is_valid %}
 <form action="{{ url_for('shop_admin.mark_reward_used', reward_id=reward.id) }}" method="POST"
 onsubmit="return confirm('{{ reward.customer.nickname or reward.customer.email }}さんの特典「{{ reward.reward_description }}」を利用済みにしますか？')">
 <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
 <button type="submit" class="btn btn-success btn-sm">利用済みにする</button>
 </form>
 {% elif reward.status == 'used' %}
 <small class="text-muted">{{ reward.used_at.strftime('%m/%d %H:%M') if reward.used_at else '' }}</small>
 {% endif %}
 </td>
 </tr>
 {% endfor %}
 </tbody>
 </table>
 </div>
 </div>
 {% else %}
 <div class="card text-center p-5">
 <p class="text-muted mb-0">
 {% if status_filter == 'pending' %}
 未使用の特典はありません。
 {% elif status_filter == 'used' %}
 利用済みの特典はありません。
 {% else %}
 特典の履歴はありません。
 {% endif %}
 </p>
 </div>
 {% endif %}

 </div>
</div>

<style>
.table {
 width: 100%;
 border-collapse: collapse;
}
.table th, .table td {
 padding: 0.75rem;
 border-bottom: 1px solid var(--color-border, #333);
 vertical-align: middle;
}
.table th {
 font-size: 0.85rem;
 color: var(--color-text-muted, #999);
 font-weight: 500;
}
.table-responsive {
 overflow-x: auto;
}
.badge-warning {
 background: #f59e0b;
 color: #000;
 padding: 0.25rem 0.5rem;
 border-radius: 4px;
 font-size: 0.8rem;
}
.badge-success {
 background: #10b981;
 color: #fff;
 padding: 0.25rem 0.5rem;
 border-radius: 4px;
 font-size: 0.8rem;
}
.badge-secondary {
 background: #6b7280;
 color: #fff;
 padding: 0.25rem 0.5rem;
 border-radius: 4px;
 font-size: 0.8rem;
}
.alert-warning {
 background: rgba(245, 158, 11, 0.15);
 border: 1px solid rgba(245, 158, 11, 0.3);
 color: #f59e0b;
 padding: 1rem;
 border-radius: 8px;
}
</style>
{% endblock %}
