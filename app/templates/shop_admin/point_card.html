{% extends "base.html" %}

{% block title %}ãƒã‚¤ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ç®¡ç† - {{ shop.name }} - Night-Walk{% endblock %}

{% block content %}
<div class="shop-admin-layout">
    <div class="shop-admin-content">
        <div class="d-flex justify-between align-center mb-4">
            <h1 class="mb-0">ğŸ´ ãƒã‚¤ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ç®¡ç†</h1>
            <div class="d-flex gap-2 align-center">
                <a href="{{ url_for('shop_admin.point_card_ranks') }}" class="btn btn-outline-primary btn-sm">
                    ğŸ‘‘ ãƒ©ãƒ³ã‚¯åˆ¶åº¦è¨­å®š
                </a>
                <span class="text-muted">{{ shop.name }}</span>
            </div>
        </div>
        
        <!-- ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div class="card mb-4">
            <div class="d-flex justify-between align-center mb-3">
                <h3 class="mb-0">ã‚«ãƒ¼ãƒ‰è¨­å®š</h3>
                <span class="badge {{ 'badge-success' if card_config.is_active else 'badge-secondary' }}">
                    {{ 'æœ‰åŠ¹' if card_config.is_active else 'ç„¡åŠ¹' }}
                </span>
            </div>
            
            <form action="{{ url_for('shop_admin.point_card_settings') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="card_name">ã‚«ãƒ¼ãƒ‰åç§°</label>
                        <input type="text" id="card_name" name="card_name" class="form-control"
                               value="{{ card_config.card_name }}" maxlength="50">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="card_color">ã‚«ãƒ¼ãƒ‰ã‚«ãƒ©ãƒ¼</label>
                        <input type="color" id="card_color" name="card_color" class="form-control"
                               value="{{ card_config.card_color }}" style="height: 42px;">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label for="visit_points">æ¥åº—ãƒã‚¤ãƒ³ãƒˆ</label>
                        <input type="number" id="visit_points" name="visit_points" class="form-control"
                               value="{{ card_config.visit_points }}" min="1">
                        <small class="form-help">1å›ã®æ¥åº—ã§ä»˜ä¸ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆ</small>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="min_visit_interval_hours">æœ€çŸ­æ¥åº—é–“éš”ï¼ˆæ™‚é–“ï¼‰</label>
                        <input type="number" id="min_visit_interval_hours" name="min_visit_interval_hours" 
                               class="form-control" value="{{ card_config.min_visit_interval_hours }}" min="0">
                        <small class="form-help">é€£ç¶šä»˜ä¸é˜²æ­¢ï¼ˆ0ã§ç„¡åˆ¶é™ï¼‰</small>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="reward_threshold">ç‰¹å…¸äº¤æ›ãƒã‚¤ãƒ³ãƒˆ</label>
                        <input type="number" id="reward_threshold" name="reward_threshold" class="form-control"
                               value="{{ card_config.reward_threshold }}" min="0">
                        <small class="form-help">ç‰¹å…¸ã¨äº¤æ›ã«å¿…è¦ãªãƒã‚¤ãƒ³ãƒˆ</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="reward_description">ç‰¹å…¸å†…å®¹</label>
                    <input type="text" id="reward_description" name="reward_description" class="form-control"
                           value="{{ card_config.reward_description or '' }}" maxlength="200"
                           placeholder="ä¾‹: ãƒ‰ãƒªãƒ³ã‚¯1æ¯ç„¡æ–™">
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="is_active" {% if card_config.is_active %}checked{% endif %}>
                        ãƒã‚¤ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary">è¨­å®šã‚’ä¿å­˜</button>
            </form>
        </div>
        
        <!-- æ¥åº—ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ -->
        <div class="card mb-4">
            <h3 class="mb-3">âœ… æ¥åº—ãƒã‚¤ãƒ³ãƒˆã‚’ä»˜ä¸</h3>
            <p class="text-muted mb-3">
                ãŠå®¢æ§˜ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ã€æ¥åº—ãƒã‚¤ãƒ³ãƒˆã‚’ä»˜ä¸ã—ã¾ã™ã€‚
            </p>
            
            <form action="{{ url_for('shop_admin.grant_visit_points') }}" method="POST" class="d-flex gap-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="email" name="customer_email" class="form-control" 
                       placeholder="ãŠå®¢æ§˜ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required style="max-width: 300px;">
                <button type="submit" class="btn btn-success">
                    {{ card_config.visit_points }}ptä»˜ä¸
                </button>
            </form>
        </div>
        
        <div class="row">
            <!-- æœ€è¿‘ã®æ¥åº—è€… -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <h3 class="mb-3">ğŸ• æœ€è¿‘ã®æ¥åº—</h3>
                    {% if recent_visitors %}
                    <div class="visitor-list">
                        {% for visitor in recent_visitors %}
                        <div class="visitor-item">
                            <div class="visitor-info">
                                <span class="visitor-name">{{ visitor.customer.nickname or visitor.customer.email }}</span>
                                <span class="visitor-points">{{ visitor.point_balance }}pt</span>
                            </div>
                            <div class="visitor-meta">
                                {{ visitor.last_visit_at.strftime('%m/%d %H:%M') if visitor.last_visit_at else '-' }}
                                ãƒ»{{ visitor.visit_count }}å›ç›®
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">ã¾ã æ¥åº—å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <h3 class="mb-3">ğŸ† å¸¸é€£ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                    {% if top_customers %}
                    <div class="ranking-list">
                        {% for rank, customer in enumerate(top_customers, 1) %}
                        <div class="ranking-item">
                            <span class="rank {% if rank <= 3 %}top{{ rank }}{% endif %}">{{ rank }}</span>
                            <span class="name">{{ customer.customer.nickname or customer.customer.email }}</span>
                            <span class="score">{{ '{:,}'.format(customer.total_earned) }}pt</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.visitor-list, .ranking-list {
    max-height: 400px;
    overflow-y: auto;
}

.visitor-item {
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--color-border);
}

.visitor-item:last-child {
    border-bottom: none;
}

.visitor-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
}

.visitor-name {
    font-weight: 500;
}

.visitor-points {
    color: var(--color-primary);
    font-weight: 600;
}

.visitor-meta {
    font-size: 0.85rem;
    color: var(--color-text-muted);
}

.ranking-item {
    display: flex;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--color-border);
}

.ranking-item:last-child {
    border-bottom: none;
}

.ranking-item .rank {
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: var(--color-bg);
    font-weight: 600;
    margin-right: 0.75rem;
}

.ranking-item .rank.top1 {
    background: linear-gradient(135deg, #ffd700, #ff8c00);
    color: #000;
}

.ranking-item .rank.top2 {
    background: linear-gradient(135deg, #c0c0c0, #a0a0a0);
    color: #000;
}

.ranking-item .rank.top3 {
    background: linear-gradient(135deg, #cd7f32, #8b4513);
    color: #fff;
}

.ranking-item .name {
    flex: 1;
}

.ranking-item .score {
    color: var(--color-primary);
    font-weight: 600;
}

.row {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -0.75rem;
}

.col-md-6 {
    flex: 0 0 50%;
    max-width: 50%;
    padding: 0 0.75rem;
}

@media (max-width: 768px) {
    .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
    }
}
</style>
{% endblock %}
