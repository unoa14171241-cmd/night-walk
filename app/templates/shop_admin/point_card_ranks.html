{% extends "base.html" %}

{% block title %}ランク制度設定 - {{ shop.name }} - Night-Walk{% endblock %}

{% block content %}
<div class="shop-admin-layout">
 <div class="shop-admin-content">
 <div class="d-flex justify-between align-center mb-4">
 <h1 class="mb-0">ランク制度設定</h1>
 <a href="{{ url_for('shop_admin.point_card') }}" class="btn btn-outline-secondary btn-sm">
 ← スタンプカード管理
 </a>
 </div>

 <!-- ランク制度ON/OFF -->
 <div class="card mb-4">
 <div class="d-flex justify-between align-center mb-3">
 <div>
 <h3 class="mb-1">ランク制度</h3>
 <p class="text-muted mb-0" style="font-size:0.85rem;">
 累計来店回数に応じてお客様のカードデザインがランクアップします。<br>
 各ランクの特典内容を自由に設定できます。
 </p>
 </div>
 <span class="badge {{ 'badge-success' if card_config.rank_system_enabled else 'badge-secondary' }}" style="font-size:0.9rem;">
 {{ '有効' if card_config.rank_system_enabled else '無効' }}
 </span>
 </div>
 <form action="{{ url_for('shop_admin.toggle_rank_system') }}" method="POST">
 <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
 {% if card_config.rank_system_enabled %}
 <button type="submit" class="btn btn-outline-danger btn-sm"
 onclick="return confirm('ランク制度を無効にしますか？（既存ランクデータは保持されます）')">
 ランク制度を無効にする
 </button>
 {% else %}
 <button type="submit" class="btn btn-primary btn-sm">
 ランク制度を有効にする
 </button>
 {% endif %}
 </form>
 </div>

 {% if card_config.rank_system_enabled %}
 <!-- ランク一覧編集 -->
 <div class="card mb-4">
 <div class="d-flex justify-between align-center mb-3">
 <h3 class="mb-0">ランク一覧</h3>
 <form action="{{ url_for('shop_admin.reset_default_ranks') }}" method="POST" style="display:inline;">
 <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
 <button type="submit" class="btn btn-outline-secondary btn-sm"
 onclick="return confirm('全ランクをデフォルトにリセットしますか？')">
 デフォルトにリセット
 </button>
 </form>
 </div>

 <form action="{{ url_for('shop_admin.save_ranks') }}" method="POST" id="ranksForm">
 <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
 <div id="deleteContainer"></div>

 <div class="rank-table-wrapper">
 <table class="rank-table" id="rankTable">
 <thead>
 <tr>
 <th style="width:40px;">Lv</th>
 <th>ランク名</th>
 <th>必要来店回数</th>
 <th>カラー</th>
 <th>テンプレート</th>
 <th>特典内容（自由入力）</th>
 <th style="width:50px;"></th>
 </tr>
 </thead>
 <tbody id="rankBody">
 {% for rank in ranks %}
 <tr data-rank-id="{{ rank.id }}">
 <td>
 <input type="hidden" name="rank_id[]" value="{{ rank.id }}">
 <input type="number" name="rank_level[]" value="{{ rank.rank_level }}"
 class="form-control form-control-sm" min="1" style="width:60px;">
 </td>
 <td>
 <input type="text" name="rank_name[]" value="{{ rank.rank_name }}"
 class="form-control form-control-sm" required maxlength="50">
 </td>
 <td>
 <input type="number" name="min_total_points[]" value="{{ rank.min_total_points }}"
 class="form-control form-control-sm" min="0">
 <small class="form-help">回</small>
 </td>
 <td>
 <input type="color" name="rank_color[]" value="{{ rank.rank_color }}"
 class="form-control form-control-sm" style="width:50px; height:32px; padding:2px;">
 </td>
 <td>
 <select name="card_template[]" class="form-control form-control-sm">
 <option value="bronze" {{ 'selected' if rank.card_template == 'bronze' }}>ブロンズ</option>
 <option value="silver" {{ 'selected' if rank.card_template == 'silver' }}>シルバー</option>
 <option value="gold" {{ 'selected' if rank.card_template == 'gold' }}>ゴールド</option>
 <option value="platinum" {{ 'selected' if rank.card_template == 'platinum' }}>プラチナ</option>
 </select>
 </td>
 <td>
 <input type="text" name="bonus_description[]" value="{{ rank.bonus_description or '' }}"
 class="form-control form-control-sm" maxlength="200" 
 placeholder="例: ドリンク1杯無料、VIP席ご案内 など">
 </td>
 <td>
 <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeRank(this)" title="削除">
 x
 </button>
 </td>
 </tr>
 {% endfor %}
 </tbody>
 </table>
 </div>

 <div class="d-flex gap-2 mt-3">
 <button type="button" class="btn btn-outline-primary btn-sm" onclick="addRank()">
 + ランクを追加
 </button>
 <button type="submit" class="btn btn-primary">設定を保存</button>
 </div>
 </form>
 </div>

 <!-- プレビュー -->
 <div class="card mb-4">
 <h3 class="mb-3">ランクプレビュー</h3>
 <p class="text-muted mb-3" style="font-size:0.85rem;">
 来店回数に応じてカードデザインが変わります。特典内容はお客様に表示されます。
 </p>
 <div class="rank-preview-grid" id="rankPreview">
 {% set template_bgs = {
 'bronze': 'linear-gradient(135deg, #CD7F32 0%, #A0522D 50%, #8B6914 100%)',
 'silver': 'linear-gradient(135deg, #C0C0C0 0%, #A8A8A8 50%, #808080 100%)',
 'gold': 'linear-gradient(135deg, #FFD700 0%, #DAA520 50%, #B8860B 100%)',
 'platinum': 'linear-gradient(135deg, #E5E4E2 0%, #BDC3C7 50%, #95A5A6 100%)'
 } %}
 {% for rank in ranks %}
 <div class="rank-preview-card" 
 style="background: {{ template_bgs.get(rank.card_template or 'bronze', template_bgs['bronze']) }};">
 <div class="rank-card-overlay"></div>
 <div class="rank-card-header">
 <span class="rank-card-name">{{ rank.rank_name }}</span>
 <span class="rank-card-level">Lv.{{ rank.rank_level }}</span>
 </div>
 <div class="rank-card-stamps">
 {% for i in range(5) %}
 <div class="rank-stamp-dot">{{ i + 1 }}</div>
 {% endfor %}
 <span class="rank-stamp-dots-more">...</span>
 </div>
 <div class="rank-card-footer">
 <div class="rank-card-condition">{{ rank.min_total_points }}回来店〜</div>
 {% if rank.bonus_description %}
 <div class="rank-card-bonus">{{ rank.bonus_description }}</div>
 {% endif %}
 </div>
 </div>
 {% endfor %}
 {% if not ranks %}
 <p class="text-muted">ランクが設定されていません</p>
 {% endif %}
 </div>
 </div>
 {% endif %}
 </div>
</div>

<style>
.rank-table-wrapper { overflow-x: auto; }

.rank-table { width: 100%; border-collapse: collapse; }

.rank-table th,
.rank-table td {
 padding: 0.5rem 0.4rem;
 border-bottom: 1px solid var(--color-border);
 vertical-align: middle;
}

.rank-table thead th {
 font-size: 0.8rem;
 color: var(--color-text-muted);
 font-weight: 600;
 white-space: nowrap;
}

.rank-table tbody tr:hover {
 background: rgba(99, 102, 241, 0.05);
}

/* ランクプレビューカード */
.rank-preview-grid {
 display: grid;
 grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
 gap: 1rem;
}

.rank-preview-card {
 position: relative;
 border-radius: 12px;
 padding: 1rem;
 color: #fff;
 min-height: 130px;
 display: flex;
 flex-direction: column;
 justify-content: space-between;
 overflow: hidden;
 box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

.rank-card-overlay {
 position: absolute;
 inset: 0;
 background: linear-gradient(180deg, rgba(0,0,0,0.15) 0%, rgba(0,0,0,0.05) 50%, rgba(0,0,0,0.25) 100%);
}

.rank-preview-card > * { position: relative; z-index: 1; }

.rank-card-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
}

.rank-card-name { font-weight: 700; font-size: 1rem; }
.rank-card-level { font-size: 0.75rem; opacity: 0.8; }

.rank-card-stamps {
 display: flex;
 gap: 6px;
 align-items: center;
 margin: 0.5rem 0;
}

.rank-stamp-dot {
 width: 24px; height: 24px;
 border-radius: 50%;
 border: 1.5px solid rgba(255,255,255,0.5);
 font-size: 0.6rem;
 display: flex; align-items: center; justify-content: center;
 color: rgba(255,255,255,0.6);
}

.rank-stamp-dots-more {
 font-size: 0.8rem;
 opacity: 0.6;
}

.rank-card-footer { font-size: 0.75rem; }
.rank-card-condition { opacity: 0.8; margin-bottom: 2px; }
.rank-card-bonus {
 background: rgba(255,255,255,0.2);
 padding: 0.15rem 0.4rem;
 border-radius: 0.5rem;
 font-size: 0.7rem;
 display: inline-block;
}

@media (max-width: 768px) {
 .rank-table { font-size: 0.85rem; }
 .rank-preview-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
}
</style>

<script>
function addRank() {
 var tbody = document.getElementById('rankBody');
 var rows = tbody.querySelectorAll('tr');
 var nextLevel = rows.length + 1;

 var tr = document.createElement('tr');
 tr.innerHTML = 
 '<td>' +
 '<input type="hidden" name="rank_id[]" value="">' +
 '<input type="number" name="rank_level[]" value="' + nextLevel + '" class="form-control form-control-sm" min="1" style="width:60px;">' +
 '</td>' +
 '<td><input type="text" name="rank_name[]" value="" class="form-control form-control-sm" required maxlength="50" placeholder="ランク名"></td>' +
 '<td><input type="number" name="min_total_points[]" value="0" class="form-control form-control-sm" min="0"><small class="form-help">回</small></td>' +
 '<td><input type="color" name="rank_color[]" value="#6366f1" class="form-control form-control-sm" style="width:50px; height:32px; padding:2px;"></td>' +
 '<td><select name="card_template[]" class="form-control form-control-sm">' +
 '<option value="bronze">ブロンズ</option><option value="silver">シルバー</option>' +
 '<option value="gold">ゴールド</option><option value="platinum">プラチナ</option>' +
 '</select></td>' +
 '<td><input type="text" name="bonus_description[]" value="" class="form-control form-control-sm" maxlength="200" placeholder="例: VIP席ご案内"></td>' +
 '<td><button type="button" class="btn btn-outline-danger btn-sm" onclick="removeRank(this)" title="削除">x</button></td>';
 tbody.appendChild(tr);
}

function removeRank(btn) {
 var tr = btn.closest('tr');
 var rankId = tr.querySelector('input[name="rank_id[]"]').value;
 if (rankId) {
 var container = document.getElementById('deleteContainer');
 var input = document.createElement('input');
 input.type = 'hidden';
 input.name = 'delete_rank_id[]';
 input.value = rankId;
 container.appendChild(input);
 }
 tr.remove();
}
</script>
{% endblock %}
