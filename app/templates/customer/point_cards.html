{% extends "customer/base.html" %}

{% block title %}スタンプカード - Night-Walk{% endblock %}

{% block content %}
<div class="container wallet-container">
 <h1 class="page-title">ウォレット</h1>
 
 <!-- 有効な特典があれば表示 -->
 {% if rewards %}
 <div class="rewards-section mb-4">
 <h3>交換済み特典</h3>
 <div class="rewards-list">
 {% for reward in rewards %}
 <div class="reward-card">
 <div class="reward-shop">{{ reward.shop.name }}</div>
 <div class="reward-description">{{ reward.reward_description }}</div>
 <div class="reward-expires">
 有効期限: {{ reward.expires_at.strftime('%Y/%m/%d') if reward.expires_at else '無期限' }}
 </div>
 </div>
 {% endfor %}
 </div>
 </div>
 {% endif %}
 
 <!-- ウォレット風スタンプカードスタック -->
 {% if cards %}
 <div class="wallet-stack" id="walletStack">
 {% for card in cards %}
 {% set card_config = card.shop.point_card %}
 {% set max_stamps = card_config.max_stamps if card_config else 10 %}
 {% set current_stamps = card.point_balance % max_stamps if max_stamps > 0 else card.point_balance %}
 {% set show_numbers = card_config.show_stamp_numbers if card_config else True %}
 {% set tpl = card_config.card_template if card_config else 'bronze' %}
 
 {# ランクによるテンプレート上書き #}
 {% if rank_map.get(card.shop_id) and rank_map[card.shop_id].rank %}
 {% set rank_tpl = rank_map[card.shop_id].rank.card_template %}
 {% if rank_tpl %}{% set tpl = rank_tpl %}{% endif %}
 {% endif %}
 
 {% set template_bgs = {
 'bronze': 'linear-gradient(135deg, #CD7F32 0%, #A0522D 50%, #8B6914 100%)',
 'silver': 'linear-gradient(135deg, #C0C0C0 0%, #A8A8A8 50%, #808080 100%)',
 'gold': 'linear-gradient(135deg, #FFD700 0%, #DAA520 50%, #B8860B 100%)',
 'platinum': 'linear-gradient(135deg, #E5E4E2 0%, #BDC3C7 50%, #95A5A6 100%)'
 } %}
 
 <a href="{{ url_for('customer.point_card_detail', shop_id=card.shop_id) }}" 
 class="wallet-card" 
 style="--card-index: {{ loop.index0 }}; --card-total: {{ cards|length }};
 {% if tpl == 'custom' and card_config and card_config.card_image_url %}
 --card-bg: url('{{ get_image_url(card_config.card_image_url, 'point_cards') }}');
 {% else %}
 --card-bg: {{ template_bgs.get(tpl, template_bgs['bronze']) }};
 {% endif %}
 ">
 <div class="wallet-card-inner {% if tpl == 'custom' and card_config and card_config.card_image_url %}has-image{% endif %}">
 <!-- カードヘッダー -->
 <div class="wallet-card-top">
 <div class="wallet-card-top-left">
 <div class="wallet-shop-name">{{ card.shop.name }}</div>
 <div class="wallet-card-label">{{ card_config.card_name if card_config else 'スタンプカード' }}</div>
 </div>
 <div class="wallet-card-top-right">
 {% if rank_map.get(card.shop_id) %}
 <div class="wallet-rank-badge">
 {{ rank_map[card.shop_id].rank_name }}
 </div>
 {% endif %}
 </div>
 </div>
 
 <!-- スタンプ表示 -->
 <div class="wallet-stamps">
 {% for i in range(max_stamps) %}
 <div class="wallet-stamp {{ 'stamped' if i < current_stamps else '' }}">
 {% if show_numbers %}{{ i + 1 }}{% endif %}
 </div>
 {% endfor %}
 </div>
 
 <!-- カードフッター -->
 <div class="wallet-card-footer">
 <div class="wallet-visits">{{ card.visit_count }}回来店</div>
 <div class="wallet-stamp-count">{{ current_stamps }}/{{ max_stamps }}</div>
 </div>
 </div>
 </a>
 {% endfor %}
 </div>
 {% else %}
 <div class="empty-state">
 <p>まだスタンプカードがありません</p>
 <p class="text-muted">店舗で口コミを投稿すると、<br>自動的にカードが発行されます。</p>
 <a href="{{ url_for('public.index') }}" class="btn btn-primary">店舗を探す</a>
 </div>
 {% endif %}
</div>

<style>
.wallet-container {
 max-width: 420px;
 margin: 0 auto;
 padding-bottom: 2rem;
}

.page-title {
 font-size: 1.75rem;
 font-weight: 700;
 margin-bottom: 1.25rem;
}

/* ========== ウォレットスタック ========== */
.wallet-stack {
 position: relative;
 perspective: 1200px;
 padding-bottom: 1rem;
}

.wallet-card {
 display: block;
 text-decoration: none;
 color: #fff;
 position: relative;
 width: 100%;
 aspect-ratio: 1.6 / 1;
 border-radius: 16px;
 overflow: hidden;
 box-shadow: 
 0 2px 8px rgba(0, 0, 0, 0.15),
 0 8px 24px rgba(0, 0, 0, 0.1);
 transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
 margin-top 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94),
 box-shadow 0.3s ease;
 z-index: calc(var(--card-total) - var(--card-index));
}

.wallet-card:not(:first-child) {
 margin-top: -160px;
}

/* 背景 */
.wallet-card-inner {
 position: relative;
 width: 100%;
 height: 100%;
 padding: 1.25rem;
 display: flex;
 flex-direction: column;
 justify-content: space-between;
 background: var(--card-bg);
 background-size: cover;
 background-position: center;
}

.wallet-card-inner.has-image {
 background-image: var(--card-bg);
 background-size: cover;
 background-position: center;
}

.wallet-card-inner::before {
 content: '';
 position: absolute;
 inset: 0;
 background: linear-gradient(
 180deg, 
 rgba(0, 0, 0, 0.25) 0%, 
 rgba(0, 0, 0, 0.05) 40%,
 rgba(0, 0, 0, 0.3) 100%
 );
 z-index: 0;
}

.wallet-card-inner > * {
 position: relative;
 z-index: 1;
}

/* ---- カード上部 ---- */
.wallet-card-top {
 display: flex;
 justify-content: space-between;
 align-items: flex-start;
}

.wallet-shop-name {
 font-size: 1rem;
 font-weight: 700;
 text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

.wallet-card-label {
 font-size: 0.7rem;
 opacity: 0.85;
 margin-top: 2px;
}

.wallet-rank-badge {
 background: rgba(255, 255, 255, 0.25);
 backdrop-filter: blur(8px);
 -webkit-backdrop-filter: blur(8px);
 padding: 0.2rem 0.65rem;
 border-radius: 1rem;
 font-size: 0.7rem;
 font-weight: 600;
 white-space: nowrap;
 border: 1px solid rgba(255, 255, 255, 0.15);
}

/* ---- スタンプ表示 ---- */
.wallet-stamps {
 display: flex;
 flex-wrap: wrap;
 gap: 6px;
 justify-content: center;
 padding: 0.25rem 0;
}

.wallet-stamp {
 width: 30px;
 height: 30px;
 border-radius: 50%;
 border: 2px solid rgba(255,255,255,0.4);
 display: flex;
 align-items: center;
 justify-content: center;
 font-size: 0.65rem;
 font-weight: 600;
 color: rgba(255,255,255,0.5);
 background: rgba(255,255,255,0.06);
 transition: all 0.3s;
}

.wallet-stamp.stamped {
 background: rgba(255,255,255,0.35);
 border-color: rgba(255,255,255,0.9);
 color: #fff;
 box-shadow: 0 0 6px rgba(255,255,255,0.25);
}

/* ---- カードフッター ---- */
.wallet-card-footer {
 display: flex;
 justify-content: space-between;
 align-items: flex-end;
}

.wallet-visits {
 font-size: 0.75rem;
 opacity: 0.85;
 background: rgba(255, 255, 255, 0.15);
 padding: 0.15rem 0.5rem;
 border-radius: 0.5rem;
}

.wallet-stamp-count {
 font-size: 0.85rem;
 font-weight: 700;
 text-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

/* ========== ホバー/展開 ========== */
.wallet-stack:hover .wallet-card:not(:first-child),
.wallet-stack.expanded .wallet-card:not(:first-child) {
 margin-top: -100px;
}

.wallet-card:hover {
 transform: translateY(-8px) scale(1.01);
 box-shadow: 
 0 4px 16px rgba(0, 0, 0, 0.2),
 0 12px 40px rgba(0, 0, 0, 0.15);
 z-index: 100;
}

.wallet-stack.fan-out .wallet-card:not(:first-child) {
 margin-top: -60px;
}

/* ========== 特典セクション ========== */
.rewards-section {
 background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(236, 72, 153, 0.1));
 border-radius: 16px;
 padding: 1rem;
}

.rewards-section h3 {
 font-size: 0.9rem;
 margin-bottom: 0.75rem;
 font-weight: 600;
}

.rewards-list {
 display: flex;
 flex-direction: column;
 gap: 0.5rem;
}

.reward-card {
 background: var(--color-bg);
 border-radius: 12px;
 padding: 0.75rem;
}

.reward-shop { font-weight: 600; margin-bottom: 0.25rem; font-size: 0.9rem; }
.reward-description { color: #f59e0b; font-weight: 500; font-size: 0.85rem; }
.reward-expires { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem; }

/* ========== 空状態 ========== */
.empty-state {
 text-align: center;
 padding: 4rem 1rem;
}

.empty-state p { margin-bottom: 0.5rem; }

/* ========== モバイル調整 ========== */
@media (max-width: 480px) {
 .wallet-card {
 border-radius: 14px;
 }
 
 .wallet-card:not(:first-child) {
 margin-top: -140px;
 }
 
 .wallet-stack:hover .wallet-card:not(:first-child),
 .wallet-stack.expanded .wallet-card:not(:first-child) {
 margin-top: -90px;
 }
 
 .wallet-stamp {
 width: 26px; height: 26px;
 font-size: 0.6rem;
 }
 
 .wallet-card-inner { padding: 1rem; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
 var stack = document.getElementById('walletStack');
 if (!stack) return;
 
 var expanded = false;
 stack.addEventListener('click', function(e) {
 if (e.target.closest('.wallet-card')) return;
 expanded = !expanded;
 stack.classList.toggle('fan-out', expanded);
 });
});
</script>
{% endblock %}
