{% extends "base.html" %}

{% block title %}ãƒãƒƒã‚¸ç®¡ç† - Night-Walk{% endblock %}

{% block content %}
<div class="admin-layout">
    {% include "admin/_sidebar.html" %}
    
    <div class="admin-content">
        <p class="mb-3">
            <a href="{{ url_for('admin.rankings') }}">â† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç®¡ç†ã«æˆ»ã‚‹</a>
        </p>
        
        <div class="d-flex justify-between align-center mb-4">
            <h1 class="mb-0">ğŸ† ãƒãƒƒã‚¸ãƒ»ç‰¹å…¸ç®¡ç†</h1>
        </div>
        
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="card mb-4">
            <form method="GET" class="d-flex gap-3" style="flex-wrap: wrap; align-items: flex-end;">
                <div class="form-group mb-0">
                    <label class="form-label">å¹´</label>
                    <select name="year" class="form-control" style="width: auto;">
                        {% for y in range(2024, 2030) %}
                        <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}å¹´</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group mb-0">
                    <label class="form-label">çŠ¶æ…‹</label>
                    <select name="status" class="form-control" style="width: auto;">
                        <option value="" {% if not status %}selected{% endif %}>ã™ã¹ã¦</option>
                        <option value="pending_ship" {% if status == 'pending_ship' %}selected{% endif %}>ç‰¹å…¸æœªç™ºé€</option>
                        <option value="shipped" {% if status == 'shipped' %}selected{% endif %}>ç™ºé€æ¸ˆã¿</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">è¡¨ç¤º</button>
            </form>
        </div>
        
        <!-- ãƒãƒƒã‚¸ä¸€è¦§ -->
        <div class="card">
            {% if badges %}
            <div style="overflow-x: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>æœŸé–“</th>
                            <th>ã‚¨ãƒªã‚¢</th>
                            <th>ãƒãƒƒã‚¸</th>
                            <th>ã‚­ãƒ£ã‚¹ãƒˆ</th>
                            <th>åº—èˆ—</th>
                            <th>æœ‰åŠ¹æœŸé–“</th>
                            <th>ç‰¹å…¸ç™ºé€</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for badge in badges %}
                        <tr>
                            <td>{{ badge.year }}å¹´{{ badge.month }}æœˆ</td>
                            <td>{{ badge.area_name }}</td>
                            <td>
                                {% if badge.badge_type == 'area_top1' %}
                                <span class="badge" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #000;">ğŸ¥‡ TOP1</span>
                                {% elif badge.badge_type == 'area_top3' %}
                                <span class="badge" style="background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: #000;">ğŸ¥ˆ TOP3</span>
                                {% else %}
                                <span class="badge" style="background: linear-gradient(135deg, #CD7F32, #8B4513); color: #fff;">ğŸ¥‰ TOP10</span>
                                {% endif %}
                            </td>
                            <td><strong>{{ badge.cast.name_display }}</strong></td>
                            <td>{{ badge.cast.shop.name if badge.cast.shop else 'â€”' }}</td>
                            <td>
                                {{ badge.valid_from.strftime('%m/%d') }} ã€œ {{ badge.valid_until.strftime('%m/%d') }}
                                {% if badge.is_valid %}
                                <span class="badge badge-success">æœ‰åŠ¹</span>
                                {% else %}
                                <span class="badge" style="background: var(--color-bg-elevated);">çµ‚äº†</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if badge.is_top1 %}
                                    {% if badge.prize_shipped %}
                                    <span class="badge badge-success">ç™ºé€æ¸ˆ</span>
                                    {% if badge.tracking_number %}
                                    <br><small>{{ badge.tracking_number }}</small>
                                    {% endif %}
                                    {% elif badge.shipping_address %}
                                    <span class="badge badge-warning">ä½æ‰€å…¥åŠ›æ¸ˆ</span>
                                    {% else %}
                                    <span class="badge badge-danger">æœªå¯¾å¿œ</span>
                                    {% endif %}
                                {% else %}
                                <span class="text-muted">â€”</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if badge.is_top1 and not badge.prize_shipped %}
                                <button type="button" class="btn btn-sm btn-primary"
                                        onclick="showShipModal({{ badge.id }}, '{{ badge.cast.name_display }}')">
                                    ç™ºé€å®Œäº†
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center">ãƒãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- ç™ºé€å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="shipModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 400px; margin: auto;">
        <h3 class="mb-3">ç‰¹å…¸ç™ºé€å®Œäº†</h3>
        <form method="POST" id="shipForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <p id="shipCastName" style="font-weight: bold;"></p>
            
            <div class="form-group">
                <label class="form-label">è¿½è·¡ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
                <input type="text" name="tracking_number" class="form-control" placeholder="1234-5678-9012">
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">ç™ºé€å®Œäº†</button>
                <button type="button" class="btn btn-secondary" onclick="closeShipModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </form>
    </div>
</div>

<script>
function showShipModal(id, name) {
    document.getElementById('shipModal').style.display = 'flex';
    document.getElementById('shipCastName').textContent = name + ' ã¸ã®ç‰¹å…¸';
    document.getElementById('shipForm').action = '/admin/rankings/badges/' + id + '/ship';
}

function closeShipModal() {
    document.getElementById('shipModal').style.display = 'none';
}
</script>
{% endblock %}
