{% extends "base.html" %}

{% block title %}„É©„É≥„Ç≠„É≥„Ç∞ÁÆ°ÁêÜ - Night-Walk{% endblock %}

{% block content %}
<div class="admin-layout">
    {% include "admin/_sidebar.html" %}
    
    <div class="admin-content">
        <div class="d-flex justify-between align-center mb-4">
            <h1 class="mb-0">„Ç≠„É£„Çπ„Éà„É©„É≥„Ç≠„É≥„Ç∞ÁÆ°ÁêÜ</h1>
            <div class="d-flex gap-2">
                <a href="{{ url_for('admin.ranking_config') }}" class="btn btn-secondary">
                    ‚öôÔ∏è ‰øÇÊï∞Ë®≠ÂÆö
                </a>
                <a href="{{ url_for('admin.ranking_badges') }}" class="btn btn-secondary">
                    üèÜ „Éê„ÉÉ„Ç∏ÁÆ°ÁêÜ
                </a>
            </div>
        </div>
        
        <!-- „Éï„Ç£„É´„Çø„Éº -->
        <div class="card mb-4">
            <form method="GET" class="d-flex gap-3" style="flex-wrap: wrap; align-items: flex-end;">
                <div class="form-group mb-0">
                    <label class="form-label">Âπ¥</label>
                    <select name="year" class="form-control" style="width: auto;">
                        {% for y in range(2024, 2030) %}
                        <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}Âπ¥</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group mb-0">
                    <label class="form-label">Êúà</label>
                    <select name="month" class="form-control" style="width: auto;">
                        {% for m in range(1, 13) %}
                        <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ m }}Êúà</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group mb-0">
                    <label class="form-label">„Ç®„É™„Ç¢</label>
                    <select name="area" class="form-control" style="width: auto;">
                        {% for key, def in areas.items() %}
                        <option value="{{ key }}" {% if key == area %}selected{% endif %}>
                            {{ def.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Ë°®Á§∫</button>
            </form>
        </div>
        
        <!-- Áµ±Ë®à„Çµ„Éû„É™„Éº -->
        <div class="d-flex gap-3 mb-4">
            <div class="card" style="flex: 1; text-align: center;">
                <div class="text-muted mb-1">„É©„É≥„Ç≠„É≥„Ç∞‰ª∂Êï∞</div>
                <div style="font-size: 1.5rem; font-weight: bold;">{{ rankings|length }}</div>
                <div class="text-muted" style="font-size: 0.85rem;">Á¢∫ÂÆö: {{ finalized_count }}‰ª∂</div>
            </div>
            <div class="card" style="flex: 1; text-align: center;">
                <div class="text-muted mb-1">Á∑èPV</div>
                <div style="font-size: 1.5rem; font-weight: bold;">{{ '{:,}'.format(total_pv) }}</div>
            </div>
            <div class="card" style="flex: 1; text-align: center;">
                <div class="text-muted mb-1">Á∑è„ÇÆ„Éï„Éàpt</div>
                <div style="font-size: 1.5rem; font-weight: bold;">{{ '{:,}'.format(total_gifts) }}</div>
            </div>
        </div>
        
        <!-- Ë®àÁÆó„ÉªÁ¢∫ÂÆö„Éú„Çø„É≥ -->
        <div class="card mb-4">
            <div class="d-flex gap-3" style="flex-wrap: wrap;">
                <form method="POST" action="{{ url_for('admin.calculate_rankings') }}" class="d-flex gap-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="year" value="{{ year }}">
                    <input type="hidden" name="month" value="{{ month }}">
                    <input type="hidden" name="area" value="{{ area }}">
                    <button type="submit" class="btn btn-secondary">üîÑ ÂÜçË®àÁÆóÔºà„Éó„É¨„Éì„É•„ÉºÔºâ</button>
                </form>
                
                <form method="POST" action="{{ url_for('admin.calculate_rankings') }}" class="d-flex gap-2"
                      onsubmit="return confirm('„Åì„ÅÆ„Ç®„É™„Ç¢„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞„ÇíÁ¢∫ÂÆö„Åó„Åæ„Åô„ÅãÔºü');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="year" value="{{ year }}">
                    <input type="hidden" name="month" value="{{ month }}">
                    <input type="hidden" name="area" value="{{ area }}">
                    <input type="hidden" name="finalize" value="on">
                    <button type="submit" class="btn btn-primary">‚úÖ „Åì„ÅÆ„Ç®„É™„Ç¢„ÇíÁ¢∫ÂÆö</button>
                </form>
                
                <form method="POST" action="{{ url_for('admin.finalize_month_rankings') }}" 
                      onsubmit="return confirm('ÂÖ®„Ç®„É™„Ç¢„ÅÆ{{ year }}Âπ¥{{ month }}Êúà„É©„É≥„Ç≠„É≥„Ç∞„ÇíÁ¢∫ÂÆö„Åó„ÄÅTOP10„Å´„Éê„ÉÉ„Ç∏„Çí‰ªò‰∏é„Åó„Åæ„Åô„ÅãÔºü');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="year" value="{{ year }}">
                    <input type="hidden" name="month" value="{{ month }}">
                    <button type="submit" class="btn btn-warning">üèÜ ÂÖ®„Ç®„É™„Ç¢Á¢∫ÂÆöÔºã„Éê„ÉÉ„Ç∏‰ªò‰∏é</button>
                </form>
            </div>
        </div>
        
        <!-- „É©„É≥„Ç≠„É≥„Ç∞„ÉÜ„Éº„Éñ„É´ -->
        <div class="card">
            <h3 class="mb-3">{{ area_definitions[area].name if area in area_definitions else area }} „É©„É≥„Ç≠„É≥„Ç∞ - {{ year }}Âπ¥{{ month }}Êúà</h3>
            
            {% if rankings %}
            <div style="overflow-x: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">È†Ü‰Ωç</th>
                            <th>„Ç≠„É£„Çπ„Éà</th>
                            <th>Â∫óËàó</th>
                            <th style="text-align: right;">PV</th>
                            <th style="text-align: right;">„ÇÆ„Éï„Éàpt</th>
                            <th style="text-align: right;">„Çπ„Ç≥„Ç¢</th>
                            <th>Áä∂ÊÖã</th>
                            <th style="width: 100px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ranking in rankings %}
                        <tr {% if ranking.rank and ranking.rank <= 3 %}style="background: rgba(255, 215, 0, 0.1);"{% endif %}>
                            <td>
                                {% if ranking.rank %}
                                    {% if ranking.rank == 1 %}
                                    <span style="font-size: 1.2rem;">ü•á</span>
                                    {% elif ranking.rank == 2 %}
                                    <span style="font-size: 1.2rem;">ü•à</span>
                                    {% elif ranking.rank == 3 %}
                                    <span style="font-size: 1.2rem;">ü•â</span>
                                    {% else %}
                                    <strong>{{ ranking.rank }}</strong>
                                    {% endif %}
                                    {% if ranking.rank_change %}
                                    <span style="font-size: 0.8rem; color: {% if '‚Üë' in ranking.rank_change %}#4CAF50{% elif '‚Üì' in ranking.rank_change %}#f44336{% else %}#999{% endif %};">
                                        {{ ranking.rank_change }}
                                    </span>
                                    {% endif %}
                                {% else %}
                                <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ ranking.cast.name_display }}</strong>
                                {% if ranking.is_overridden %}
                                <span class="badge badge-warning" title="{{ ranking.override_reason }}">Â§âÊõ¥</span>
                                {% endif %}
                            </td>
                            <td>{{ ranking.cast.shop.name if ranking.cast.shop else '‚Äî' }}</td>
                            <td style="text-align: right;">{{ '{:,}'.format(ranking.pv_count) }}</td>
                            <td style="text-align: right;">{{ '{:,}'.format(ranking.gift_points) }}</td>
                            <td style="text-align: right;"><strong>{{ '{:,.1f}'.format(ranking.total_score) }}</strong></td>
                            <td>
                                {% if ranking.is_finalized %}
                                <span class="badge badge-success">Á¢∫ÂÆö</span>
                                {% else %}
                                <span class="badge" style="background: var(--color-bg-elevated);">Êú™Á¢∫ÂÆö</span>
                                {% endif %}
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-secondary" 
                                        onclick="showOverrideModal({{ ranking.id }}, '{{ ranking.cast.name_display }}', {{ ranking.rank or 0 }})">
                                    Á∑®ÈõÜ
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted text-center">„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- È†Ü‰ΩçÂ§âÊõ¥„É¢„Éº„ÉÄ„É´ -->
<div id="overrideModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 400px; margin: auto;">
        <h3 class="mb-3">È†Ü‰ΩçÂ§âÊõ¥</h3>
        <form method="POST" id="overrideForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <p id="overrideCastName" style="font-weight: bold;"></p>
            
            <div class="form-group">
                <label class="form-label">Êñ∞„Åó„ÅÑÈ†Ü‰Ωç</label>
                <input type="number" name="new_rank" id="newRank" class="form-control" min="1" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Â§âÊõ¥ÁêÜÁî± *</label>
                <input type="text" name="reason" class="form-control" placeholder="‰∏çÊ≠£Ë°åÁÇ∫„ÄÅË™§ÈõÜË®à„Å™„Å©" required>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Â§âÊõ¥</button>
                <button type="button" class="btn btn-secondary" onclick="closeOverrideModal()">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </form>
        
        <hr style="margin: var(--space-lg) 0; border-color: var(--color-border);">
        
        <form method="POST" id="disqualifyForm" onsubmit="return confirm('„Åì„ÅÆ„Ç≠„É£„Çπ„Éà„ÇíÂ§±Ê†º„Å´„Åó„Åæ„Åô„ÅãÔºü');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label class="form-label">Â§±Ê†ºÁêÜÁî±</label>
                <input type="text" name="reason" class="form-control" placeholder="‰∏çÊ≠£Ë°åÁÇ∫„Å™„Å©">
            </div>
            <button type="submit" class="btn btn-danger">Â§±Ê†º„Å´„Åô„Çã</button>
        </form>
    </div>
</div>

<script>
function showOverrideModal(id, name, currentRank) {
    document.getElementById('overrideModal').style.display = 'flex';
    document.getElementById('overrideCastName').textContent = name;
    document.getElementById('newRank').value = currentRank;
    document.getElementById('overrideForm').action = '/admin/rankings/' + id + '/override';
    document.getElementById('disqualifyForm').action = '/admin/rankings/' + id + '/disqualify';
}

function closeOverrideModal() {
    document.getElementById('overrideModal').style.display = 'none';
}
</script>
{% endblock %}
