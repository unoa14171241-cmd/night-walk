{% extends "base.html" %}

{% block title %}月次請求 - Night-Walk{% endblock %}

{% block content %}
<div class="admin-layout">
    {% include "admin/_sidebar.html" %}
    
    <div class="admin-content">
        <div class="d-flex justify-between align-center mb-4">
            <h1 class="mb-0">月次請求</h1>
        </div>
        
        <!-- Filters -->
        <div class="card mb-4">
            <form method="GET" class="filter-form">
                <div class="filter-grid">
                    <div class="filter-item">
                        <label>年</label>
                        <select name="year" class="form-control" onchange="this.form.submit()">
                            {% for y in range(2024, 2030) %}
                            <option value="{{ y }}" {% if year == y %}selected{% endif %}>
                                {{ y }}年
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-item">
                        <label>店舗</label>
                        <select name="shop_id" class="form-control" onchange="this.form.submit()">
                            <option value="">すべて</option>
                            {% for shop in shops %}
                            <option value="{{ shop.id }}" {% if selected_shop == shop.id %}selected{% endif %}>
                                {{ shop.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Monthly Summary -->
        {% if monthly_totals %}
        <div class="monthly-summary mb-4">
            <h3 class="mb-3">{{ year }}年 月別集計</h3>
            <div class="month-cards">
                {% for m in range(1, 13) %}
                {% set totals = monthly_totals.get(m, {'count': 0, 'amount': 0}) %}
                <div class="month-card {% if totals.amount > 0 %}has-data{% endif %}">
                    <div class="month-name">{{ m }}月</div>
                    {% if totals.amount > 0 %}
                    <div class="month-count">{{ totals.count }}件</div>
                    <div class="month-amount">¥{{ "{:,}".format(totals.amount) }}</div>
                    {% else %}
                    <div class="month-empty">−</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Billings List -->
        <div class="card">
            <h3 class="mb-3">請求一覧</h3>
            
            {% if billings %}
            <table class="table">
                <thead>
                    <tr>
                        <th>期間</th>
                        <th>店舗</th>
                        <th>件数</th>
                        <th>小計</th>
                        <th>税額</th>
                        <th>合計</th>
                        <th>状態</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for billing, shop in billings %}
                    <tr>
                        <td><strong>{{ billing.period_display }}</strong></td>
                        <td>{{ shop.name }}</td>
                        <td>{{ billing.total_commissions }}件</td>
                        <td>¥{{ "{:,}".format(billing.subtotal) }}</td>
                        <td>¥{{ "{:,}".format(billing.tax_amount) }}</td>
                        <td><strong class="text-primary">¥{{ "{:,}".format(billing.total_amount) }}</strong></td>
                        <td>
                            {% if billing.status == 'open' %}
                            <span class="badge badge-warning">{{ billing.status_label }}</span>
                            {% elif billing.status == 'closed' %}
                            <span class="badge badge-info">{{ billing.status_label }}</span>
                            {% elif billing.status == 'invoiced' %}
                            <span class="badge" style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6;">{{ billing.status_label }}</span>
                            {% elif billing.status == 'paid' %}
                            <span class="badge badge-success">{{ billing.status_label }}</span>
                            {% elif billing.status == 'overdue' %}
                            <span class="badge badge-danger">{{ billing.status_label }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('admin.monthly_billing_detail', id=billing.id) }}" class="btn btn-sm btn-secondary">
                                詳細
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted text-center">{{ year }}年の請求データがありません</p>
            {% endif %}
        </div>
    </div>
</div>

<style>
.filter-form {
    margin: 0;
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-md);
}

.filter-item label {
    display: block;
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin-bottom: var(--space-xs);
}

.monthly-summary {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
}

.month-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: var(--space-sm);
}

.month-card {
    background: var(--color-bg-elevated);
    border-radius: var(--radius-md);
    padding: var(--space-sm);
    text-align: center;
}

.month-card.has-data {
    border: 1px solid var(--color-primary);
}

.month-name {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin-bottom: var(--space-xs);
}

.month-count {
    font-size: 0.7rem;
    color: var(--color-text-muted);
}

.month-amount {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-primary);
}

.month-empty {
    font-size: 0.875rem;
    color: var(--color-text-dim);
}
</style>
{% endblock %}
