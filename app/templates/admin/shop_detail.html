{% extends "base.html" %}

{% block title %}{{ shop.name }} - 店舗詳細 - Night-Walk{% endblock %}

{% block content %}
<div class="admin-layout">
 {% include "admin/_sidebar.html" %}
 
 <div class="admin-content">
 <p class="mb-3">
 <a href="{{ url_for('admin.shops') }}">← 店舗一覧に戻る</a>
 </p>
 
 <div class="d-flex justify-between align-center mb-4">
 <div>
 <h1 class="mb-1">{{ shop.name }}</h1>
 <p class="text-muted mb-0"> {{ shop.area }}</p>
 </div>
 <div class="d-flex gap-2">
 <a href="{{ url_for('admin.edit_shop', shop_id=shop.id) }}" class="btn btn-secondary">
 編集
 </a>
 <a href="{{ url_for('shop_admin.select_shop', shop_id=shop.id) }}" class="btn btn-primary">
 店舗として管理
 </a>
 <form method="POST" action="{{ url_for('admin.toggle_shop', shop_id=shop.id) }}" style="display: inline;">
 <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
 <button type="submit" class="btn {% if shop.is_active %}btn-danger{% else %}btn-secondary{% endif %}">
 {% if shop.is_active %}無効化{% else %}有効化{% endif %}
 </button>
 </form>
 </div>
 </div>
 
 <!-- Shop Info -->
 <div class="card mb-4">
 <h3 class="mb-3">店舗情報</h3>
 <table class="table" style="margin: 0;">
 <tr>
 <th style="width: 150px;">審査状態</th>
 <td>
 {% if shop.review_status == 'pending' %}
 <span class="badge badge-warning">審査待ち</span>
 {% elif shop.review_status == 'approved' %}
 <span class="badge badge-success">承認済み</span>
 {% elif shop.review_status == 'rejected' %}
 <span class="badge badge-danger">却下</span>
 {% endif %}
 {% if shop.reviewed_at %}
 <span class="text-muted" style="font-size: 0.85em; margin-left: 8px;">
 {{ shop.reviewed_at.strftime('%Y/%m/%d %H:%M') }}
 </span>
 {% endif %}
 </td>
 </tr>
 <tr>
 <th>公開状態</th>
 <td>
 {% if shop.is_active %}
 {% if shop.is_published %}
 <span class="badge badge-success">公開中</span>
 {% else %}
 <span class="badge badge-warning">非公開</span>
 {% endif %}
 {% else %}
 <span class="badge badge-danger">無効</span>
 {% endif %}
 </td>
 </tr>
 <tr>
 <th>カテゴリ</th>
 <td>{{ shop.category_label or '未設定' }}</td>
 </tr>
 <tr>
 <th>送客手数料</th>
 <td>
 {% if custom_rate %}
 <span class="badge badge-primary">カスタム設定</span>
 {{ custom_rate.rate_display }}
 {% else %}
 <span class="badge" style="background: var(--color-bg-elevated);">デフォルト</span>
 ¥{{ '{:,}'.format(default_commission) }}/件
 {% endif %}
 <a href="{{ url_for('admin.edit_commission_rate', shop_id=shop.id) }}" class="text-primary" style="margin-left: 8px; font-size: 0.9em;">設定変更</a>
 </td>
 </tr>
 <tr>
 <th>電話番号</th>
 <td>{{ shop.phone or '−' }}</td>
 </tr>
 <tr>
 <th>住所</th>
 <td>{{ shop.address or '−' }}</td>
 </tr>
 <tr>
 <th>営業時間</th>
 <td>{{ shop.business_hours or '−' }}</td>
 </tr>
 <tr>
 <th>料金目安</th>
 <td>{{ shop.price_range or '−' }}</td>
 </tr>
 <tr>
 <th>登録日</th>
 <td>{{ shop.created_at.strftime('%Y/%m/%d %H:%M') }}</td>
 </tr>
 </table>
 </div>
 
 <!-- Members -->
 <div class="card mb-4">
 <h3 class="mb-3">スタッフ</h3>
 
 {% if members %}
 <table class="table mb-3">
 <thead>
 <tr>
 <th>名前</th>
 <th>メール</th>
 <th>権限</th>
 </tr>
 </thead>
 <tbody>
 {% for member in members %}
 <tr>
 <td>{{ member.user.name }}</td>
 <td>{{ member.user.email }}</td>
 <td>
 {% if member.role == 'owner' %}
 <span class="badge badge-warning">オーナー</span>
 {% else %}
 <span class="badge" style="background: var(--color-bg-elevated);">スタッフ</span>
 {% endif %}
 </td>
 </tr>
 {% endfor %}
 </tbody>
 </table>
 {% else %}
 <p class="text-muted mb-3">まだスタッフが登録されていません</p>
 {% endif %}
 
 <!-- Add Member Form -->
 <form method="POST" action="{{ url_for('admin.add_shop_member', shop_id=shop.id) }}" class="d-flex gap-2" style="flex-wrap: wrap;">
 <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
 <input type="email" name="email" class="form-control" placeholder="メールアドレス" required style="flex: 1; min-width: 200px;">
 <select name="role" class="form-control" style="width: auto;">
 <option value="staff">スタッフ</option>
 <option value="owner">オーナー</option>
 </select>
 <button type="submit" class="btn btn-secondary">追加</button>
 </form>
 </div>
 
 <!-- Subscription -->
 <div class="card">
 <h3 class="mb-3">課金情報</h3>
 {% if shop.subscription %}
 <table class="table" style="margin: 0;">
 <tr>
 <th style="width: 150px;">ステータス</th>
 <td>
 <span class="badge badge-{% if shop.subscription.is_active %}success{% elif shop.subscription.is_past_due %}warning{% else %}danger{% endif %}">
 {{ shop.subscription.status_label }}
 </span>
 </td>
 </tr>
 <tr>
 <th>プラン</th>
 <td>{{ shop.subscription.plan | upper }}</td>
 </tr>
 <tr>
 <th>Stripe Customer</th>
 <td>{{ shop.subscription.stripe_customer_id or '−' }}</td>
 </tr>
 </table>
 {% else %}
 <p class="text-muted">サブスクリプション未設定</p>
 {% endif %}
 </div>
 
 <!-- 審査アクション（審査待ちの場合のみ表示） -->
 {% if shop.review_status == 'pending' %}
 <div class="card mt-4 review-action-card">
 <h3 class="mb-3"> 審査アクション</h3>
 <p class="text-muted mb-3">この店舗は審査待ちです。承認すると管理画面へのログインが可能になります。</p>
 
 <div class="d-flex gap-2" style="flex-wrap: wrap;">
 <form method="POST" action="{{ url_for('admin.approve_shop', shop_id=shop.id) }}" style="display: inline;">
 <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
 <button type="submit" class="btn btn-success" onclick="return confirm('この店舗を承認しますか？管理画面へのログインが可能になります。')">
 承認する
 </button>
 </form>
 
 <button type="button" class="btn btn-danger" onclick="document.getElementById('rejectModal').style.display='flex'">
 却下する
 </button>
 </div>
 </div>
 
 <!-- 却下モーダル -->
 <div id="rejectModal" class="modal-overlay" style="display: none;">
 <div class="modal-content">
 <h3>店舗却下</h3>
 <form method="POST" action="{{ url_for('admin.reject_shop', shop_id=shop.id) }}">
 <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
 <div class="form-group">
 <label class="form-label">却下理由（必須）</label>
 <textarea name="notes" class="form-control" rows="3" required placeholder="却下の理由を入力してください"></textarea>
 </div>
 <div class="d-flex gap-2 mt-3">
 <button type="submit" class="btn btn-danger">却下する</button>
 <button type="button" class="btn btn-secondary" onclick="document.getElementById('rejectModal').style.display='none'">キャンセル</button>
 </div>
 </form>
 </div>
 </div>
 {% endif %}
 
 <!-- 店舗削除 -->
 <div class="card mt-4" style="border: 1px solid var(--color-danger);">
 <h3 class="mb-3"> 危険な操作</h3>
 <p class="text-muted mb-3">店舗を完全に削除します。関連する全てのデータ（キャスト、ギフト履歴、予約、課金情報など）も削除されます。<strong>この操作は取り消せません。</strong></p>
 <form method="POST" action="{{ url_for('admin.delete_shop', shop_id=shop.id) }}" style="display: inline;">
 <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
 <button type="submit" class="btn btn-danger" 
 onclick="return confirm(' 本当に店舗「{{ shop.name }}」を完全に削除しますか？\n\n関連する全てのデータ（キャスト、ギフト履歴、予約、課金情報など）も削除されます。\nこの操作は取り消せません。')">
 店舗を完全に削除
 </button>
 </form>
 </div>
 
 <!-- キャンペーン振込設定 -->
 <div class="card mt-4">
 <h3 class="mb-3"> キャンペーン振込設定</h3>
 <table class="table" style="margin-bottom: var(--space-md);">
 <tr>
 <th style="width: 150px;">無料期間</th>
 <td>
 {% if shop.campaign_free_months and shop.campaign_free_months > 0 %}
 {{ shop.campaign_free_months }}ヶ月
 {% if shop.is_in_free_period %}
 <span class="badge badge-success">適用中</span>
 （〜{{ shop.free_period_end_date.strftime('%Y/%m/%d') }}まで）
 {% else %}
 <span class="badge" style="background: var(--color-bg-elevated);">終了</span>
 {% endif %}
 {% else %}
 <span class="text-muted">なし</span>
 {% endif %}
 </td>
 </tr>
 <tr>
 <th>特別条件</th>
 <td>{{ shop.campaign_notes or '−' }}</td>
 </tr>
 <tr>
 <th>振込サイクル</th>
 <td>月末締め / 翌月{{ shop.payout_day or 5 }}営業日払い</td>
 </tr>
 <tr>
 <th>次回振込予定</th>
 <td>{{ shop.get_next_payout_date().strftime('%Y/%m/%d') }}</td>
 </tr>
 </table>
 <a href="{{ url_for('admin.shop_campaign', shop_id=shop.id) }}" class="btn btn-secondary btn-sm">
 設定変更
 </a>
 </div>
 </div>
</div>

<style>
.review-action-card {
 border: 2px solid var(--color-warning);
 background: rgba(255, 193, 7, 0.05);
}

.modal-overlay {
 position: fixed;
 top: 0;
 left: 0;
 right: 0;
 bottom: 0;
 background: rgba(0, 0, 0, 0.7);
 display: flex;
 align-items: center;
 justify-content: center;
 z-index: 1000;
}

.modal-content {
 background: var(--color-bg-elevated);
 padding: var(--space-xl);
 border-radius: var(--radius-lg);
 max-width: 500px;
 width: 90%;
}

.modal-content h3 {
 margin-bottom: var(--space-lg);
}

.gap-2 {
 gap: var(--space-sm);
}

.mt-3 {
 margin-top: var(--space-md);
}

.mt-4 {
 margin-top: var(--space-lg);
}
</style>
{% endblock %}
