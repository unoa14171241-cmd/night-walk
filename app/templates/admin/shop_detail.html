{% extends "base.html" %}

{% block title %}{{ shop.name }} - åº—èˆ—è©³ç´° - Night-Walk{% endblock %}

{% block content %}
<div class="admin-layout">
    {% include "admin/_sidebar.html" %}
    
    <div class="admin-content">
        <p class="mb-3">
            <a href="{{ url_for('admin.shops') }}">â† åº—èˆ—ä¸€è¦§ã«æˆ»ã‚‹</a>
        </p>
        
        <div class="d-flex justify-between align-center mb-4">
            <div>
                <h1 class="mb-1">{{ shop.name }}</h1>
                <p class="text-muted mb-0">ğŸ“ {{ shop.area }}</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('admin.edit_shop', shop_id=shop.id) }}" class="btn btn-secondary">
                    ç·¨é›†
                </a>
                <a href="{{ url_for('shop_admin.select_shop', shop_id=shop.id) }}" class="btn btn-primary">
                    åº—èˆ—ã¨ã—ã¦ç®¡ç†
                </a>
                <form method="POST" action="{{ url_for('admin.toggle_shop', shop_id=shop.id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn {% if shop.is_active %}btn-danger{% else %}btn-secondary{% endif %}">
                        {% if shop.is_active %}ç„¡åŠ¹åŒ–{% else %}æœ‰åŠ¹åŒ–{% endif %}
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Shop Info -->
        <div class="card mb-4">
            <h3 class="mb-3">åº—èˆ—æƒ…å ±</h3>
            <table class="table" style="margin: 0;">
                <tr>
                    <th style="width: 150px;">å¯©æŸ»çŠ¶æ…‹</th>
                    <td>
                        {% if shop.review_status == 'pending' %}
                        <span class="badge badge-warning">å¯©æŸ»å¾…ã¡</span>
                        {% elif shop.review_status == 'approved' %}
                        <span class="badge badge-success">æ‰¿èªæ¸ˆã¿</span>
                        {% elif shop.review_status == 'rejected' %}
                        <span class="badge badge-danger">å´ä¸‹</span>
                        {% endif %}
                        {% if shop.reviewed_at %}
                        <span class="text-muted" style="font-size: 0.85em; margin-left: 8px;">
                            {{ shop.reviewed_at.strftime('%Y/%m/%d %H:%M') }}
                        </span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>å…¬é–‹çŠ¶æ…‹</th>
                    <td>
                        {% if shop.is_active %}
                            {% if shop.is_published %}
                            <span class="badge badge-success">å…¬é–‹ä¸­</span>
                            {% else %}
                            <span class="badge badge-warning">éå…¬é–‹</span>
                            {% endif %}
                        {% else %}
                        <span class="badge badge-danger">ç„¡åŠ¹</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>ã‚«ãƒ†ã‚´ãƒª</th>
                    <td>{{ shop.category_label or 'æœªè¨­å®š' }}</td>
                </tr>
                <tr>
                    <th>é€å®¢æ‰‹æ•°æ–™</th>
                    <td>
                        {% if custom_rate %}
                        <span class="badge badge-primary">ã‚«ã‚¹ã‚¿ãƒ è¨­å®š</span>
                        {{ custom_rate.rate_display }}
                        {% else %}
                        <span class="badge" style="background: var(--color-bg-elevated);">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</span>
                        Â¥{{ '{:,}'.format(default_commission) }}/ä»¶
                        {% endif %}
                        <a href="{{ url_for('admin.edit_commission_rate', shop_id=shop.id) }}" class="text-primary" style="margin-left: 8px; font-size: 0.9em;">è¨­å®šå¤‰æ›´</a>
                    </td>
                </tr>
                <tr>
                    <th>é›»è©±ç•ªå·</th>
                    <td>{{ shop.phone or 'âˆ’' }}</td>
                </tr>
                <tr>
                    <th>ä½æ‰€</th>
                    <td>{{ shop.address or 'âˆ’' }}</td>
                </tr>
                <tr>
                    <th>å–¶æ¥­æ™‚é–“</th>
                    <td>{{ shop.business_hours or 'âˆ’' }}</td>
                </tr>
                <tr>
                    <th>æ–™é‡‘ç›®å®‰</th>
                    <td>{{ shop.price_range or 'âˆ’' }}</td>
                </tr>
                <tr>
                    <th>ç™»éŒ²æ—¥</th>
                    <td>{{ shop.created_at.strftime('%Y/%m/%d %H:%M') }}</td>
                </tr>
            </table>
        </div>
        
        <!-- Members -->
        <div class="card mb-4">
            <h3 class="mb-3">ã‚¹ã‚¿ãƒƒãƒ•</h3>
            
            {% if members %}
            <table class="table mb-3">
                <thead>
                    <tr>
                        <th>åå‰</th>
                        <th>ãƒ¡ãƒ¼ãƒ«</th>
                        <th>æ¨©é™</th>
                    </tr>
                </thead>
                <tbody>
                    {% for member in members %}
                    <tr>
                        <td>{{ member.user.name }}</td>
                        <td>{{ member.user.email }}</td>
                        <td>
                            {% if member.role == 'owner' %}
                            <span class="badge badge-warning">ã‚ªãƒ¼ãƒŠãƒ¼</span>
                            {% else %}
                            <span class="badge" style="background: var(--color-bg-elevated);">ã‚¹ã‚¿ãƒƒãƒ•</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted mb-3">ã¾ã ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            {% endif %}
            
            <!-- Add Member Form -->
            <form method="POST" action="{{ url_for('admin.add_shop_member', shop_id=shop.id) }}" class="d-flex gap-2" style="flex-wrap: wrap;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="email" name="email" class="form-control" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required style="flex: 1; min-width: 200px;">
                <select name="role" class="form-control" style="width: auto;">
                    <option value="staff">ã‚¹ã‚¿ãƒƒãƒ•</option>
                    <option value="owner">ã‚ªãƒ¼ãƒŠãƒ¼</option>
                </select>
                <button type="submit" class="btn btn-secondary">è¿½åŠ </button>
            </form>
        </div>
        
        <!-- Subscription -->
        <div class="card">
            <h3 class="mb-3">èª²é‡‘æƒ…å ±</h3>
            {% if shop.subscription %}
            <table class="table" style="margin: 0;">
                <tr>
                    <th style="width: 150px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                    <td>
                        <span class="badge badge-{% if shop.subscription.is_active %}success{% elif shop.subscription.is_past_due %}warning{% else %}danger{% endif %}">
                            {{ shop.subscription.status_label }}
                        </span>
                    </td>
                </tr>
                <tr>
                    <th>ãƒ—ãƒ©ãƒ³</th>
                    <td>{{ shop.subscription.plan | upper }}</td>
                </tr>
                <tr>
                    <th>Stripe Customer</th>
                    <td>{{ shop.subscription.stripe_customer_id or 'âˆ’' }}</td>
                </tr>
            </table>
            {% else %}
            <p class="text-muted">ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æœªè¨­å®š</p>
            {% endif %}
        </div>
        
        <!-- å¯©æŸ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå¯©æŸ»å¾…ã¡ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
        {% if shop.review_status == 'pending' %}
        <div class="card mt-4 review-action-card">
            <h3 class="mb-3">ğŸ” å¯©æŸ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
            <p class="text-muted mb-3">ã“ã®åº—èˆ—ã¯å¯©æŸ»å¾…ã¡ã§ã™ã€‚æ‰¿èªã™ã‚‹ã¨ç®¡ç†ç”»é¢ã¸ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>
            
            <div class="d-flex gap-2" style="flex-wrap: wrap;">
                <form method="POST" action="{{ url_for('admin.approve_shop', shop_id=shop.id) }}" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-success" onclick="return confirm('ã“ã®åº—èˆ—ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿç®¡ç†ç”»é¢ã¸ã®ãƒ­ã‚°ã‚¤ãƒ³ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚')">
                        âœ… æ‰¿èªã™ã‚‹
                    </button>
                </form>
                
                <button type="button" class="btn btn-danger" onclick="document.getElementById('rejectModal').style.display='flex'">
                    âŒ å´ä¸‹ã™ã‚‹
                </button>
            </div>
        </div>
        
        <!-- å´ä¸‹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="rejectModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <h3>åº—èˆ—å´ä¸‹</h3>
                <form method="POST" action="{{ url_for('admin.reject_shop', shop_id=shop.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="form-group">
                        <label class="form-label">å´ä¸‹ç†ç”±ï¼ˆå¿…é ˆï¼‰</label>
                        <textarea name="notes" class="form-control" rows="3" required placeholder="å´ä¸‹ã®ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" class="btn btn-danger">å´ä¸‹ã™ã‚‹</button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('rejectModal').style.display='none'">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
        
        <!-- åº—èˆ—å‰Šé™¤ -->
        <div class="card mt-4" style="border: 1px solid var(--color-danger);">
            <h3 class="mb-3">âš ï¸ å±é™ºãªæ“ä½œ</h3>
            <p class="text-muted mb-3">åº—èˆ—ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚é–¢é€£ã™ã‚‹å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚­ãƒ£ã‚¹ãƒˆã€ã‚®ãƒ•ãƒˆå±¥æ­´ã€äºˆç´„ã€èª²é‡‘æƒ…å ±ãªã©ï¼‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚<strong>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</strong></p>
            <form method="POST" action="{{ url_for('admin.delete_shop', shop_id=shop.id) }}" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-danger" 
                        onclick="return confirm('âš ï¸ æœ¬å½“ã«åº—èˆ—ã€Œ{{ shop.name }}ã€ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\né–¢é€£ã™ã‚‹å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚­ãƒ£ã‚¹ãƒˆã€ã‚®ãƒ•ãƒˆå±¥æ­´ã€äºˆç´„ã€èª²é‡‘æƒ…å ±ãªã©ï¼‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')">
                    ğŸ—‘ï¸ åº—èˆ—ã‚’å®Œå…¨ã«å‰Šé™¤
                </button>
            </form>
        </div>
        
        <!-- ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ»æŒ¯è¾¼è¨­å®š -->
        <div class="card mt-4">
            <h3 class="mb-3">ğŸ’° ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ»æŒ¯è¾¼è¨­å®š</h3>
            <table class="table" style="margin-bottom: var(--space-md);">
                <tr>
                    <th style="width: 150px;">ç„¡æ–™æœŸé–“</th>
                    <td>
                        {% if shop.campaign_free_months and shop.campaign_free_months > 0 %}
                        {{ shop.campaign_free_months }}ãƒ¶æœˆ
                        {% if shop.is_in_free_period %}
                        <span class="badge badge-success">é©ç”¨ä¸­</span>
                        ï¼ˆã€œ{{ shop.free_period_end_date.strftime('%Y/%m/%d') }}ã¾ã§ï¼‰
                        {% else %}
                        <span class="badge" style="background: var(--color-bg-elevated);">çµ‚äº†</span>
                        {% endif %}
                        {% else %}
                        <span class="text-muted">ãªã—</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>ç‰¹åˆ¥æ¡ä»¶</th>
                    <td>{{ shop.campaign_notes or 'âˆ’' }}</td>
                </tr>
                <tr>
                    <th>æŒ¯è¾¼ã‚µã‚¤ã‚¯ãƒ«</th>
                    <td>æœˆæœ«ç· ã‚ / ç¿Œæœˆ{{ shop.payout_day or 5 }}å–¶æ¥­æ—¥æ‰•ã„</td>
                </tr>
                <tr>
                    <th>æ¬¡å›æŒ¯è¾¼äºˆå®š</th>
                    <td>{{ shop.get_next_payout_date().strftime('%Y/%m/%d') }}</td>
                </tr>
            </table>
            <a href="{{ url_for('admin.shop_campaign', shop_id=shop.id) }}" class="btn btn-secondary btn-sm">
                è¨­å®šå¤‰æ›´
            </a>
        </div>
    </div>
</div>

<style>
.review-action-card {
    border: 2px solid var(--color-warning);
    background: rgba(255, 193, 7, 0.05);
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--color-bg-elevated);
    padding: var(--space-xl);
    border-radius: var(--radius-lg);
    max-width: 500px;
    width: 90%;
}

.modal-content h3 {
    margin-bottom: var(--space-lg);
}

.gap-2 {
    gap: var(--space-sm);
}

.mt-3 {
    margin-top: var(--space-md);
}

.mt-4 {
    margin-top: var(--space-lg);
}
</style>
{% endblock %}
