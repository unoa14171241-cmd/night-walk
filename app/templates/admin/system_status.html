{% extends "base.html" %}

{% block title %}ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ - Night-Walk{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="page-header">
        <div>
            <h1>ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h1>
            <p class="text-muted">éšœå®³å¯¾å¿œãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ç®¡ç†</p>
        </div>
    </div>
    
    <!-- ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div class="card mb-4" style="border-left: 4px solid var(--color-{% if current_status.status == 'normal' %}success{% elif current_status.status == 'degraded' %}warning{% elif current_status.status == 'maintenance' %}info{% else %}danger{% endif %});">
        <div class="d-flex justify-between align-center">
            <div>
                <h3 class="mb-1">
                    ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: 
                    <span class="badge badge-{{ current_status.status_color }}">{{ current_status.status_label }}</span>
                </h3>
                {% if current_status.title %}
                <p class="mb-0">{{ current_status.title }}</p>
                {% endif %}
            </div>
            {% if current_status.started_at and not current_status.is_resolved %}
            <form action="{{ url_for('admin.resolve_incident', incident_id=current_status.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-success">âœ… è§£æ±ºæ¸ˆã¿ã«ã™ã‚‹</button>
            </form>
            {% endif %}
        </div>
        {% if current_status.message %}
        <p class="text-muted mt-2 mb-0" style="white-space: pre-wrap;">{{ current_status.message }}</p>
        {% endif %}
        {% if current_status.started_at %}
        <p class="text-muted mt-2 mb-0" style="font-size: 0.8rem;">
            é–‹å§‹: {{ current_status.started_at.strftime('%Y/%m/%d %H:%M') }}
            {% if current_status.duration_minutes > 0 %}
            ï¼ˆ{{ current_status.duration_minutes }}åˆ†çµŒéï¼‰
            {% endif %}
        </p>
        {% endif %}
    </div>
    
    <!-- ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç™»éŒ² -->
    <div class="card mb-4">
        <h3 class="mb-3">ğŸš¨ ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç™»éŒ²</h3>
        <form method="POST" action="{{ url_for('admin.create_incident') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div class="form-row">
                <div class="form-group col-md-4">
                    <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                    <select name="status" class="form-control">
                        <option value="degraded">âš ï¸ ä¸€éƒ¨éšœå®³</option>
                        <option value="maintenance">ğŸ”§ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­</option>
                        <option value="outage">ğŸ”´ å…¨é¢éšœå®³</option>
                    </select>
                </div>
                <div class="form-group col-md-8">
                    <label>ã‚¿ã‚¤ãƒˆãƒ« <span class="required">*</span></label>
                    <input type="text" name="title" class="form-control" required
                           placeholder="ä¾‹: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šéšœå®³">
                </div>
            </div>
            
            <div class="form-group">
                <label>è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                <textarea name="message" class="form-control" rows="2"
                          placeholder="ä¾‹: ç¾åœ¨ã€ä¸€éƒ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„äº‹è±¡ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚"></textarea>
            </div>
            
            <div class="form-group">
                <label>å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚µãƒ¼ãƒ“ã‚¹</label>
                <input type="text" name="affected_services" class="form-control"
                       placeholder="ä¾‹: ãƒ­ã‚°ã‚¤ãƒ³, åº—èˆ—æ¤œç´¢, äºˆç´„">
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="notify_users">
                    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹
                </label>
            </div>
            
            <button type="submit" class="btn btn-warning">ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç™»éŒ²</button>
        </form>
    </div>
    
    <!-- éå»ã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ -->
    {% if incidents %}
    <div class="card mb-4">
        <h3 class="mb-3">ğŸ“‹ éå»ã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>æ—¥æ™‚</th>
                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                    <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                    <th>ç¶™ç¶šæ™‚é–“</th>
                    <th>çŠ¶æ…‹</th>
                </tr>
            </thead>
            <tbody>
                {% for incident in incidents %}
                <tr>
                    <td>{{ incident.created_at.strftime('%Y/%m/%d %H:%M') }}</td>
                    <td><span class="badge badge-{{ incident.status_color }}">{{ incident.status_label }}</span></td>
                    <td>{{ incident.title }}</td>
                    <td>{{ incident.duration_minutes }}åˆ†</td>
                    <td>
                        {% if incident.is_resolved %}
                        <span class="badge badge-success">è§£æ±ºæ¸ˆã¿</span>
                        {% else %}
                        <span class="badge badge-warning">å¯¾å¿œä¸­</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- æœ€è¿‘ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚° -->
    {% if recent_errors %}
    <div class="card">
        <div class="d-flex justify-between align-center mb-3">
            <h3 class="mb-0">ğŸ“ æœ€è¿‘ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°</h3>
            <a href="{{ url_for('admin.system_logs') }}" class="btn btn-sm btn-outline">ã™ã¹ã¦ã®ãƒ­ã‚°</a>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>æ—¥æ™‚</th>
                        <th>ãƒ¬ãƒ™ãƒ«</th>
                        <th>ã‚«ãƒ†ã‚´ãƒª</th>
                        <th>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in recent_errors %}
                    <tr>
                        <td style="white-space: nowrap;">{{ log.created_at.strftime('%m/%d %H:%M') }}</td>
                        <td>
                            <span class="badge badge-{% if log.level == 'critical' %}danger{% else %}warning{% endif %}">
                                {{ log.level }}
                            </span>
                        </td>
                        <td>{{ log.category or '-' }}</td>
                        <td style="font-size: 0.8rem;">{{ log.message[:100] }}{% if log.message|length > 100 %}...{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="card text-center" style="padding: 2rem;">
        <p class="text-muted mb-0">æœ€è¿‘ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ âœ…</p>
    </div>
    {% endif %}
</div>
{% endblock %}
