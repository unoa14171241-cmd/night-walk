{% extends "customer/base.html" %}

{% block title %}{{ shop.name }} | {{ shop.area }}ã®{{ shop.category_label or 'åº—èˆ—' }} - Night-Walk{% endblock %}

{% block meta_description %}{{ shop.name }}ã¯{{ shop.area }}ã«ã‚ã‚‹{{ shop.category_label or 'åº—èˆ—' }}ã§ã™ã€‚{% if shop.business_hours %}å–¶æ¥­æ™‚é–“: {{ shop.business_hours }}{% endif %}{% if shop.price_range %} æ–™é‡‘: {{ shop.price_range }}{% endif %} ç©ºå¸­çŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèªã§ãã¾ã™ã€‚{% endblock %}

{% block og_type %}place{% endblock %}

{% block og_image %}{% if images and images[0] %}{{ images[0].url }}{% else %}{{ url_for('static', filename='images/ogp-default.png', _external=True) }}{% endif %}{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  "name": "{{ shop.name }}",
  "description": "{{ (shop.description or (shop.area ~ 'ã«ã‚ã‚‹' ~ (shop.category_label or 'åº—èˆ—'))) | replace('"', '\\"') | truncate(200) }}",
  "address": {
    "@type": "PostalAddress",
    "addressLocality": "{{ shop.area }}",
    "addressRegion": "å²¡å±±çœŒ",
    "addressCountry": "JP"
  },
  "url": "{{ request.url }}"
  {%- if shop.phone %},
  "telephone": "{{ shop.phone }}"
  {%- endif %}
  {%- if shop.business_hours %},
  "openingHours": "{{ shop.business_hours }}"
  {%- endif %}
  {%- if images and images|length > 0 %},
  "image": "{{ images[0].url }}"
  {%- endif %}
  {%- if review_data and review_data.count and review_data.count > 0 %},
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ review_data.average | round(1) }}",
    "reviewCount": "{{ review_data.count }}",
    "bestRating": "5",
    "worstRating": "1"
  }
  {%- endif %}
}
</script>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Back Link -->
    <p class="mb-3">
        <a href="{{ url_for('public.search') }}">â† åº—èˆ—æ¤œç´¢ã«æˆ»ã‚‹</a>
    </p>
    
    <!-- Image Gallery -->
    <div class="shop-gallery mb-4">
        {% if images %}
        <div class="gallery-main">
            <img src="{{ images[0].url }}" alt="{{ shop.name }}" id="gallery-main-image">
        </div>
        {% if images | length > 1 %}
        <div class="gallery-thumbs">
            {% for image in images %}
            <div class="gallery-thumb {% if loop.first %}active{% endif %}" 
                 onclick="setMainImage('{{ image.url }}', this)">
                <img src="{{ image.url }}" alt="" loading="lazy">
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% elif shop.image_url %}
        <div class="gallery-main">
            <img src="{{ shop.image_url }}" alt="{{ shop.name }}">
        </div>
        {% else %}
        <div class="gallery-main gallery-placeholder">
            <span>ğŸŒ™</span>
            <p>{{ shop.name }}</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Shop Info Header -->
    <div class="shop-detail-header-info mb-4">
        <div class="d-flex justify-between align-center">
            <div>
                <div class="d-flex align-center gap-2 mb-2">
                    <h1 class="mb-0">{{ shop.name }}</h1>
                    {% if shop.is_featured %}
                    <span class="badge badge-warning">ãŠã™ã™ã‚</span>
                    {% endif %}
                </div>
                <p class="text-muted mb-0">
                    ğŸ“ {{ shop.area }}
                    {% if shop.category_label %}
                    ãƒ» {{ shop.category_label }}
                    {% endif %}
                </p>
            </div>
            <div class="text-end">
                <span class="vacancy-badge vacancy-badge-lg vacancy-{{ vacancy_colors.get(shop.current_vacancy, 'secondary') }} d-block mb-2">
                    {{ vacancy_labels.get(shop.current_vacancy, 'âˆ’') }}
                </span>
                <!-- ç›´å‰äºˆç´„ãƒœã‚¿ãƒ³ -->
                <a href="{{ url_for('customer.booking', shop_id=shop.id) }}" class="btn btn-primary btn-sm">
                    ğŸ“… ç›´å‰äºˆç´„ï¼ˆ30ã€œ60åˆ†å¾Œï¼‰
                </a>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="shop-detail-info">
        <!-- Left Column: Info -->
        <div>
            <!-- Description -->
            {% if shop.description %}
            <div class="info-section">
                <h3>ç´¹ä»‹</h3>
                <div class="card">
                    <p style="white-space: pre-line;">{{ shop.description }}</p>
                </div>
            </div>
            {% endif %}
            
            <!-- Tags -->
            {% if shop.tags_list %}
            <div class="info-section">
                <div class="shop-tags">
                    {% for tag in shop.tags_list %}
                    <span class="shop-tag">#{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Details -->
            <div class="info-section">
                <h3>åº—èˆ—æƒ…å ±</h3>
                <div class="card">
                    <table class="table" style="margin: 0;">
                        {% if shop.business_hours %}
                        <tr>
                            <th style="width: 100px;">å–¶æ¥­æ™‚é–“</th>
                            <td>{{ shop.business_hours }}</td>
                        </tr>
                        {% endif %}
                        {% if shop.price_range %}
                        <tr>
                            <th>æ–™é‡‘ç›®å®‰</th>
                            <td>{{ shop.price_range }}</td>
                        </tr>
                        {% endif %}
                        {% if shop.phone %}
                        <tr>
                            <th>é›»è©±ç•ªå·</th>
                            <td>
                                <a href="tel:{{ shop.phone }}">{{ shop.phone }}</a>
                            </td>
                        </tr>
                        {% endif %}
                        {% if shop.address %}
                        <tr>
                            <th>ä½æ‰€</th>
                            <td>{{ shop.address }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
            
            <!-- Casts Section -->
            {% if casts %}
            <div class="info-section">
                <h3>ã‚­ãƒ£ã‚¹ãƒˆç´¹ä»‹</h3>
                <div class="cast-grid">
                    {% for cast in casts %}
                    <a href="{{ url_for('customer.cast_detail', cast_id=cast.id) }}" class="cast-preview-card">
                        <div class="cast-preview-image">
                            <img src="{{ cast.image_url }}" alt="{{ cast.name_display }}" loading="lazy">
                        </div>
                        <div class="cast-preview-info">
                            <span class="cast-preview-name">{{ cast.name_display }}</span>
                            {% if cast.is_accepting_gifts %}
                            <span class="badge badge-sm badge-success">ã‚®ãƒ•ãƒˆå—ä»˜ä¸­</span>
                            {% endif %}
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Job Posting -->
            {% if job and job.is_visible %}
            <div class="info-section">
                <h3>æ±‚äººæƒ…å ±</h3>
                <div class="card" style="border-color: var(--color-accent-pink);">
                    <div class="d-flex align-center gap-2 mb-2">
                        <span class="badge badge-danger">æ€¥å‹Ÿ</span>
                    </div>
                    
                    {% if job.hourly_wage %}
                    <p class="mb-1"><strong>æ™‚çµ¦:</strong> {{ job.hourly_wage }}</p>
                    {% endif %}
                    
                    {% if job.benefits %}
                    <p class="mb-1"><strong>å¾…é‡:</strong> {{ job.benefits }}</p>
                    {% endif %}
                    
                    {% if job.trial_available %}
                    <p class="mb-0">
                        <span class="badge badge-success">ä½“é¨“å…¥åº—OK</span>
                    </p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Reviews Section -->
            <div class="info-section">
                <div class="d-flex justify-between align-center mb-3">
                    <h3 class="mb-0">å£ã‚³ãƒŸè©•ä¾¡</h3>
                    <a href="{{ url_for('customer.submit_review', shop_id=shop.id) }}" class="btn btn-outline-primary btn-sm">
                        å£ã‚³ãƒŸã‚’æŠ•ç¨¿
                    </a>
                </div>
                
                <!-- Rating Summary -->
                <div class="card mb-3">
                    <div class="review-summary">
                        <div class="review-average">
                            <span class="review-score">{{ '%.1f'|format(review_data.average) if review_data.average > 0 else '-' }}</span>
                            <div class="review-stars">
                                {% for i in range(1, 6) %}
                                <span class="star {% if i <= review_data.average|round %}filled{% endif %}">â˜…</span>
                                {% endfor %}
                            </div>
                            <span class="review-count">{{ review_data.count }}ä»¶ã®è©•ä¾¡</span>
                        </div>
                        
                        {% if review_data.count > 0 %}
                        <div class="review-distribution">
                            {% for i in range(5, 0, -1) %}
                            <div class="rating-bar-row">
                                <span class="rating-label">{{ i }}</span>
                                <div class="rating-bar">
                                    <div class="rating-bar-fill" style="width: {{ (review_data.distribution[i] / review_data.count * 100) if review_data.count > 0 else 0 }}%;"></div>
                                </div>
                                <span class="rating-count">{{ review_data.distribution[i] }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Recent Reviews -->
                {% if recent_reviews %}
                <div class="recent-reviews">
                    {% for review in recent_reviews %}
                    <div class="review-item">
                        <div class="review-item-rating">
                            {% for i in range(1, 6) %}
                            <span class="star small {% if i <= review.rating %}filled{% endif %}">â˜…</span>
                            {% endfor %}
                        </div>
                        <span class="review-item-date">{{ review.created_at.strftime('%Y/%m/%d') }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center py-3">
                    ã¾ã å£ã‚³ãƒŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                    <a href="{{ url_for('customer.submit_review', shop_id=shop.id) }}">æœ€åˆã®å£ã‚³ãƒŸã‚’æŠ•ç¨¿ã™ã‚‹</a>
                </p>
                {% endif %}
                
                <!-- Review Reward Notice -->
                <div class="review-reward-notice mt-3">
                    <span class="reward-icon">ğŸ</span>
                    <span>å£ã‚³ãƒŸæŠ•ç¨¿ã§ <strong>500ãƒã‚¤ãƒ³ãƒˆ</strong> ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆï¼</span>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Booking CTA -->
        <div>
            <div class="booking-cta">
                <h3>ä»Šã™ãäºˆç´„</h3>
                
                <div class="mb-3">
                    <span class="vacancy-badge vacancy-badge-lg vacancy-{{ vacancy_colors.get(shop.current_vacancy, 'secondary') }}">
                        {{ vacancy_labels.get(shop.current_vacancy, 'âˆ’') }}
                    </span>
                    {% if shop.vacancy_updated_at %}
                    <p class="text-muted mt-2" style="font-size: 0.75rem;">
                        {{ shop.vacancy_updated_at.strftime('%H:%M') }} æ›´æ–°
                    </p>
                    {% endif %}
                </div>
                
                {% if shop.phone %}
                <a href="{{ url_for('public.booking', shop_id=shop.id) }}" class="phone-btn">
                    é›»è©±ã§äºˆç´„
                </a>
                <p class="text-muted mt-2" style="font-size: 0.75rem;">
                    ã‚¿ãƒƒãƒ—ã§äºˆç´„å—ä»˜ã¸
                </p>
                {% else %}
                <p class="text-muted">
                    é›»è©±ç•ªå·ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.shop-gallery {
    border-radius: var(--radius-xl);
    overflow: hidden;
}

.gallery-main {
    width: 100%;
    height: 400px;
    background: var(--color-bg-elevated);
    display: flex;
    align-items: center;
    justify-content: center;
}

.gallery-main img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.gallery-placeholder {
    flex-direction: column;
    color: var(--color-text-muted);
}

.gallery-placeholder span {
    font-size: 4rem;
    margin-bottom: var(--space-md);
}

.gallery-thumbs {
    display: flex;
    gap: var(--space-sm);
    padding: var(--space-sm);
    background: var(--color-bg-card);
    overflow-x: auto;
}

.gallery-thumb {
    width: 80px;
    height: 60px;
    flex-shrink: 0;
    border-radius: var(--radius-sm);
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color var(--transition-fast);
}

.gallery-thumb.active {
    border-color: var(--color-primary);
}

.gallery-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.shop-detail-header-info {
    padding: var(--space-lg);
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
}

.shop-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
}

.shop-tag {
    padding: var(--space-xs) var(--space-md);
    background: var(--color-bg-elevated);
    border-radius: var(--radius-full);
    font-size: 0.875rem;
    color: var(--color-primary);
}

/* Cast Grid */
.cast-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: var(--space-md);
}

.cast-preview-card {
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    overflow: hidden;
    text-decoration: none;
    color: var(--color-text);
    transition: var(--transition-base);
}

.cast-preview-card:hover {
    border-color: var(--color-primary);
    transform: translateY(-2px);
}

.cast-preview-image {
    aspect-ratio: 1;
    overflow: hidden;
}

.cast-preview-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.cast-preview-info {
    padding: var(--space-sm);
    text-align: center;
}

.cast-preview-name {
    display: block;
    font-weight: 500;
    margin-bottom: var(--space-xs);
}

.badge-sm {
    font-size: 0.625rem;
    padding: 2px 6px;
}

@media (max-width: 768px) {
    .gallery-main {
        height: 250px;
    }
    
    .cast-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

/* Reviews Section */
.review-summary {
    display: flex;
    gap: var(--space-xl);
    flex-wrap: wrap;
}

.review-average {
    text-align: center;
    min-width: 120px;
}

.review-score {
    display: block;
    font-size: 3rem;
    font-weight: bold;
    color: var(--color-primary-light);
    line-height: 1;
}

.review-stars {
    margin: var(--space-sm) 0;
}

.star {
    color: var(--color-text-muted);
    font-size: 1.25rem;
}

.star.filled {
    color: #ffc107;
}

.star.small {
    font-size: 0.875rem;
}

.review-count {
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.review-distribution {
    flex: 1;
    min-width: 200px;
}

.rating-bar-row {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-xs);
}

.rating-label {
    width: 20px;
    text-align: center;
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.rating-bar {
    flex: 1;
    height: 8px;
    background: var(--color-bg-elevated);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.rating-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary), var(--color-accent-gold));
    border-radius: var(--radius-full);
    transition: width 0.3s;
}

.rating-count {
    width: 30px;
    text-align: right;
    font-size: 0.75rem;
    color: var(--color-text-muted);
}

.recent-reviews {
    border-top: 1px solid var(--color-border);
    padding-top: var(--space-md);
}

.review-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) 0;
    border-bottom: 1px solid var(--color-border);
}

.review-item:last-child {
    border-bottom: none;
}

.review-item-date {
    font-size: 0.75rem;
    color: var(--color-text-muted);
}

.review-reward-notice {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: linear-gradient(90deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05));
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
}

.reward-icon {
    font-size: 1.25rem;
}
</style>

{% block extra_js %}
<script>
function setMainImage(url, thumb) {
    document.getElementById('gallery-main-image').src = url;
    
    document.querySelectorAll('.gallery-thumb').forEach(t => {
        t.classList.remove('active');
    });
    thumb.classList.add('active');
}
</script>
{% endblock %}
{% endblock %}
